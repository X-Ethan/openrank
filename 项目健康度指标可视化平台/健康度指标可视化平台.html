<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <title>项目健康度指标可视化平台</title>
    <link rel="stylesheet" href="echart/style.css?v=8">
</head>

<body>
    <!-- 头部模块 -->
    <header>
        <h1><span>项目健康度指标可视化平台</span></h1>
        <p><span>Data visualization total</span></p>
    </header>
    <script src="amcharts/amcharts.js" type="text/javascript"></script>
    <script src="amcharts/serial.js" type="text/javascript"></script>
    <div id="search" style="position: absolute;top: 50px;left: 30px;width: 500px;height: 30px;">
        <input type="text" id="warehouse1" name="warehouse1" placeholder="仓库1"
            style="position: absolute; background-color:transparent;outline:none;border:1px solid #666;left:0px;margin-left:5px;top:10px;height:28px;width:200px;line-height:1px;color:#c1c6c8;font-size: 13px; "
            value="X-lab2017/open-digger" autocomplete="true">
        <input type="text" id="warehouse2" name="warehouse2" placeholder="仓库2"
            style="position: absolute; background-color:transparent;outline:none;border:1px solid #666;left:0px;margin-left:5px;top:10px;height:28px;width:200px;left:210px;line-height:1px;color:#c1c6c8;font-size: 13px; "
            value="" autocomplete="true">
        <input type="button" value="" onclick="geturldata()"
            style="cursor:pointer; position: absolute; background:url(echart/searchBTn1.png) no-repeat center center;top:5px;left:450px;width:30px;height:30px;margin:5px;background-size: contain; border:0px;" />
    </div>
    <div id="legend"
        style="position: absolute;top: 50px;right: 30px;width: 200px;height: 30px;display:flex;flex-direction:row;">
        <div id="leg1"
            style="width:80px;text-align: right;line-height:30px;color:#999;font-size:15px;position: relative;top: 10px;">
            仓库1
        </div>
        <div id="leg1col1"
            style="width:15px;height:15px;background-color:#dc67ce; border-radius:5px;margin:auto 0;margin-left:10px;position: relative;top: 10px">
        </div>
        <div id="leg2"
            style="width:80px;text-align: right;line-height:30px;color:#999;font-size:15px;position: relative;top: 10px">
            仓库2
        </div>
        <div id="leg1col2"
            style="margin-left:10px;width:15px;height:15px;background-color:#dcd267; border-radius:5px;margin:auto 0;margin-left:10px;position: relative;top: 10px">
        </div>
    </div>
    <div class="main" style="display:flex;flex-direction:row;">
        <div class="row" style="flex:1;display:flex;flex-direction:column;margin-top:-8px;">
            <div class="cell" style="flex:1;">
                <fieldset
                    style="width:100%;height:100%;margin: 0 auto;border:0px;border-top:1px solid #666;display:flex;flex-direction:row;">
                    <legend class="table-caption" style="margin:0px auto;font-size: 20px;font-weight:200px;color:#fff">
                        　活 跃 度 指 标　</legend>
                    <div id="chartdiv1" style="flex:1;width: 100%;height:100%;"></div>
                    <div id="chartdiv2" style="flex:1;width: 100%;height:100%;"></div>
                </fieldset>
            </div>
            <div class="cell" style="flex:1;">
                <fieldset
                    style="width:100%;height:100%;margin: 0 auto;border:0px;border-top:1px solid #666;display:flex;flex-direction:row;">
                    <legend class="table-caption" style="margin:0px auto;font-size: 20px;font-weight:200px;color:#fff">
                        　社 区 参 与 度 指 标　</legend>
                    <div id="chartdiv5" style="flex:1;width: 100%;height:100%;"></div>
                    <div id="chartdiv6" style="flex:1;width: 100%;height:100%;"></div>
                </fieldset>
            </div>
        </div>
        <div class="row" style="flex:1;display:flex;flex-direction:column;margin-top:-8px;">
            <div class="cell" style="flex:1;">
                <fieldset
                    style="width:100%;height:100%;margin: 0 auto;border:0px;border-top:1px solid #666;border-left:1px solid #666;display:flex;flex-direction:row;">
                    <legend class="table-caption" style="margin:0px auto;font-size: 20px;font-weight:200px;color:#fff">
                        　代 码 质 量 指 标　</legend>
                    <div id="chartdiv3" style="flex:1;width: 100%;height:100%;"></div>
                    <div id="boxp" style="flex:1;width: 100%;height:100%;display:flex;flex-direction:column;">
                        <div id="titlebox" style="width: 100%;height:35px;display: flex;flex-direction:row;">
                            <div id="t1" style="flex:1;text-align:center;line-height: 40px; color:#fff;">仓库1</div>
                            <div id="t2" style="flex:1;text-align:center;line-height: 40px; color:#fff;">仓库2</div>
                        </div>
                        <div id="divbox" style="flex:1;width: 100%;height:100%;display: flex;flex-direction:row;">
                            <div id="chartdiv4" style="flex:1;width: 100%;height:100%;margin:auto 0;"></div>
                            <div id="chartdiv9" style="flex:1;width: 100%;height:100%;margin:auto 0;"></div>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="cell" style="flex:1;">
                <fieldset
                    style="width:100%;height:100%;margin: 0 auto;border:0px;border-top:1px solid #666;border-left:1px solid #666;display:flex;flex-direction:row;">
                    <legend class="table-caption" style="margin:0px auto;font-size: 20px;font-weight:200px;color:#fff">
                        　项 目 发 展 指 标　</legend>
                    <div id="chartdiv7" style="flex:1;width: 100%;height:100%;"></div>
                    <div id="chartdiv8" style="flex:1;width: 100%;height:100%;"></div>
                </fieldset>
            </div>
        </div>
    </div>

    <!-- 底部模块 -->
    <div class="bottom">
        <h5><span style="display: block; margin-top: 15px;">进　入</span></h5>
        <p>Data Status</p>
    </div>

</body>
<script src="amcharts/v4-core.js"></script>
<script src="amcharts/v4-charts.js"></script>
<script src="amcharts/v4-animated.js"></script>
<script src="amcharts/v4-forceDirected.js"></script>
<script src="js/jquery-3.5.1.min.js"></script>

<script>
    $(window).ready(function () {
        setsize();
    })
    $(window).resize(function () {
        setsize();
    });
    function setsize() {
        let topheight = 0;
        let bottomheight = 0;
        if ($(window).width() <= 1200) {
            topheight = 55;
            bottomheight = 50;
            mtop = 10;
        } else if ($(window).width() >= 1920) {
            topheight = $(window).width() * 0.045;
            mtop = topheight - 50;
            bottomheight = 98;
        } else if ($(window).width() >= 2560) {
            topheight = 115;
            bottomheight = 98;
            mtop = 60;
        } else {
            topheight = $(window).width() * 0.045;
            bottomheight = $(window).width() * 0.04;
            mtop = topheight - 50;
        };
        $("header").height(topheight);
        $(".main").height($(window).height() - topheight - bottomheight);
        $(".cell").width($(".main").width() / 2);
        $(".cell").height($(".main").height() / 2);
        $("#search").css("top", mtop + "px");
        $("#legend").css("top", mtop + "px");
    }



    var dataarr = [
        {
            index: 0,
            divname: "chartdiv1",
            title: "近期活动次数",
            preflag: false,
            tipformat: "[font-size:13px]{categoryX}: {valueY}[/]",
            tipformat1: "[font-size:13px]{categoryX}: {valueY}[/]"
        }, {
            index: 1,
            divname: "chartdiv2",
            title: "新贡献者增长率",
            preflag: true,
            tipformat: "[font-size:13px]{categoryX}：上期.{pre}；本期.{this}[/]",
            tipformat1: "[font-size:13px]{categoryX}：上期.{pre1}；本期.{this1}[/]"
        }, {
            index: 4,
            divname: "chartdiv3",
            title: "问题响应率",
            preflag: true,
            tipformat: "[font-size:13px]{categoryX}：回应.{qus}；问题数.{ask}[/]",
            tipformat1: "[font-size:13px]{categoryX}：回应.{qus1}；问题数.{ask1}[/]"
        }, {
            index: 6,
            divname: "chartdiv5",
            title: "代码更改稳定性",
            preflag: false,
            tipformat: "[font-size:13px]{categoryX}：新增.{add}；删除.{remove}[/]",
            tipformat1: "[font-size:13px]{categoryX}：新增.{add1}；删除.{remove1}[/]"
        }, {
            index: 8,
            divname: "chartdiv6",
            title: "代码问题密度",
            preflag: false,
            tipformat: "[font-size:13px]{categoryX}：问题数量.{avg}；代码行数.{num}[/]",
            tipformat1: "[font-size:13px]{categoryX}：问题数量.{avg1}；代码行数.{num1}[/]"
        }, {
            index: 9,
            divname: "chartdiv7",
            title: "OpenRank趋势",
            preflag: false,
            tipformat: "[font-size:13px]{categoryX}: {valueY}[/]",
            tipformat1: "[font-size:13px]{categoryX}: {valueY}[/]"
        }, {
            index: 11,
            divname: "chartdiv8",
            title: "变更请求接受率",
            preflag: true,
            tipformat: "[font-size:13px]{categoryX}：被接受.{acc}；请求数.{num}[/]",
            tipformat1: "[font-size:13px]{categoryX}：被接受.{acc1}；请求数.{num1}[/]"
        }, {
            index: 2,
            divname: "chartdiv4",
            title: "仓库1"
        }, {
            index: 14,
            title: "仓库2",
            divname: "chartdiv9"
        }
    ];

    var cData = [], urls = [];
    var isboth = false;
    function geturldata() {
        var gdata;
        var ishas = 0;
        var warehouse_name = $("#warehouse1").val();
        var warehouse_name1 = $("#warehouse2").val();
        isboth = false;
        if (warehouse_name == "" && warehouse_name1 == "") {
            return;
        }
        urls = [];
        if (warehouse_name != "") {
            ishas = 12;
            urls[0] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/active_dates_and_times.json";
            urls[1] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/new_contributors_detail.json";
            urls[2] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/developer_network.json";

            urls[3] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/issues_new.json";
            urls[4] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/issues_closed.json";

            urls[5] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/code_change_lines_add.json";
            urls[6] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/code_change_lines_remove.json";

            urls[7] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/issue_age.json";
            urls[8] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/code_change_lines_sum.json";

            urls[9] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/openrank.json";

            urls[10] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/change_requests_accepted.json";
            urls[11] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name + "/change_requests.json";
        }

        if (warehouse_name1 != "") {
            urls[0 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/active_dates_and_times.json";
            urls[1 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/new_contributors_detail.json";
            urls[2 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/developer_network.json";

            urls[3 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/issues_new.json";
            urls[4 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/issues_closed.json";

            urls[5 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/code_change_lines_add.json";
            urls[6 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/code_change_lines_remove.json";

            urls[7 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/issue_age.json";
            urls[8 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/code_change_lines_sum.json";

            urls[9 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/openrank.json";

            urls[10 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/change_requests_accepted.json";
            urls[11 + ishas] = "https://oss.x-lab.info/open_digger/github/" + warehouse_name1 + "/change_requests.json";
        }
        cData = [];
        for (var i = 0; i < urls.length; i++) {
            var item1;
            cData[i] = xmldata(urls[i]);
            if (cData[i] == "failed") {
                alert("获取数据指定仓库数据失败！");
                return;
            }
            if (i != 2 && i != 14) {
                if (i == 7 || i == 19) {
                    var keys = ["avg", "levels", "quantile_0", "quantile_1", "quantile_2", "quantile_3", "quantile_4"];
                    keys.forEach(item => {
                        cData[i][item] = Object.entries(cData[i][item]).filter(([key, value]) => key.includes("-"));
                        cData[i][item] = cData[i][item].map(item => {
                            return { 'xdata': item[0], 'ydata': item[1], 'ydata1': 0 };
                        });
                    })
                } else {
                    cData[i] = Object.entries(cData[i]).filter(([key, value]) => key.includes("-"));
                    if (i == 0 || i == 12) {
                        cData[i] = cData[i].map(item => {
                            return { 'xdata': item[0].replace("-raw", ""), 'ydata': item[1].reduce((sum, cval) => sum + cval, 0), 'ydata1': 0 };
                        });
                    } else if (i == 1 || i == 13) {
                        var tval = 0, newarr = [];
                        newarr[0] = { 'xdata': cData[i][0][0], 'ydata': 0, 'pre': 0, 'this': cData[i][0][1].length, 'ydata1': 0, 'pre1': 0, 'this1': 0 };
                        for (var j = 1; j < cData[i].length; j++) {
                            tval = parseFloat(((cData[i][j][1].length - cData[i][j - 1][1].length) / cData[i][j - 1][1].length * 100).toFixed(2));
                            newarr[j] = { 'xdata': cData[i][j][0], 'ydata': tval, 'pre': cData[i][j - 1][1].length, 'this': cData[i][j][1].length, 'ydata1': 0, 'pre1': 0, 'this1': 0 };
                        }
                        cData[i] = newarr;
                    } else {
                        cData[i] = cData[i].map(item => {
                            return { 'xdata': item[0].replace("-raw", ""), 'ydata': item[1], 'ydata1': 0 };
                        });
                    }
                }
                var findex = 0, sarr = [], farr = [], nflag = true;
                var val1 = "", val2 = "";
                if (i == 12) {
                    for (var k = 0; k < cData[i].length; k++) {
                        findex = cData[0].findIndex(item => item.xdata === cData[i][k]["xdata"]);
                        if (findex == -1) {
                            cData[0].push({ "xdata": cData[i][k]["xdata"], 'ydata': 0, 'ydata1': cData[i][k]["ydata"] });
                        } else {
                            cData[0][findex]["ydata1"] = cData[i][k]["ydata"];
                        }
                    }
                    cData[0].sort(function (a, b) {
                        return new Date(a.xdata + '-01') - new Date(b.xdata + '-01');
                    });
                }
                if (i == 13) {
                    findex = cData[1].findIndex(item => item.xdata === cData[i][0]["xdata"]);
                    if (findex == -1) {
                        cData[1].push({ "xdata": cData[i][0]["xdata"], 'ydata': 0, 'ydata1': 0, 'pre1': cData[i][0]["pre"], 'this1': cData[i][0]["this"], 'pre': 0, 'this': 0 });
                    } else {
                        cData[1][findex]["ydata1"] = cData[i][0]["ydata"];
                        cData[1][findex]["pre1"] = cData[i][0]["pre"];
                        cData[1][findex]["this1"] = cData[i][0]["this"];
                    }

                    for (var k = 1; k < cData[i].length; k++) {
                        findex = cData[1].findIndex(item => item.xdata === cData[i][k]["xdata"]);
                        if (findex == -1) {
                            cData[1].push({ "xdata": cData[i][k]["xdata"], 'ydata': 0, 'ydata1': cData[i][k]["ydata"], 'pre1': cData[i][k]["pre"], 'this1': cData[i][k]["this"], 'pre': 0, 'this': 0 });
                        } else {
                            cData[1][findex]["ydata1"] = cData[i][k]["ydata"];
                            cData[1][findex]["pre1"] = cData[i][k]["pre"];
                            cData[1][findex]["this1"] = cData[i][k]["this"];
                        }
                    }
                    cData[1].sort(function (a, b) {
                        return new Date(a.xdata + '-01') - new Date(b.xdata + '-01');
                    });
                }
                if (i == 21) {
                    for (var k = 0; k < cData[i].length; k++) {
                        findex = cData[9].findIndex(item => item.xdata === cData[i][k]["xdata"]);
                        if (findex == -1) {
                            cData[9].push({ "xdata": cData[i][k]["xdata"], 'ydata': 0, 'ydata1': cData[i][k]["ydata"] });
                        } else {
                            cData[9][findex]["ydata1"] = cData[i][k]["ydata"];
                        }
                    }
                    cData[9].sort(function (a, b) {
                        return new Date(a.xdata + '-01') - new Date(b.xdata + '-01');
                    });
                }
                if (i == 4 || i == 16) {
                    var newarr = [], tavl = 0, tval1 = "";
                    if (cData[i - 1].length >= cData[i].length) {
                        sarr = cData[i - 1];
                        farr = cData[i];
                        nflag = true;
                    } else {
                        sarr = cData[i];
                        farr = cData[i - 1];
                        nflag = false;
                    }
                    for (var k = 0; k < sarr.length; k++) {
                        findex = newarr.findIndex(item => item.xdata === sarr[k]["xdata"]);
                        if (findex == -1) {
                            item1 = farr.find(item => item.xdata === sarr[k]["xdata"]);
                            if (nflag) {
                                if (item1 == undefined) {
                                    val1 = sarr[k]["ydata"];
                                    val2 = 0;
                                } else {
                                    val1 = sarr[k]["ydata"];
                                    val2 = item1["ydata"];
                                }
                            } else {
                                if (item1 == undefined) {
                                    val1 = 0;
                                    val2 = sarr[k]["ydata"];
                                } else {
                                    val1 = item1["ydata"];
                                    val2 = sarr[k]["ydata"];
                                }
                            }
                            if (val1 == 0) {
                                tval = 0;
                            } else {
                                tval = parseFloat(val2 / val1 * 100).toFixed(2);
                            }
                            if (i == 4) {
                                newarr[k] = { 'xdata': sarr[k]["xdata"], 'ydata': tval, 'ask': val1, 'qus': val2, 'ydata1': 0, 'ask1': 0, 'qus1': 0 };
                            } else {
                                findex = cData[4].findIndex(item => item.xdata === sarr[k]["xdata"]);
                                if (findex == -1) {
                                    cData[4].push({ "xdata": sarr[k]["xdata"], 'ydata': 0, 'ydata1': tval, 'qus1': val2, 'ask1': val1, 'ask': 0, 'qus': 0 });
                                } else {
                                    cData[4][findex]["ydata1"] = tval;
                                    cData[4][findex]["ask1"] = val1;
                                    cData[4][findex]["qus1"] = val2;
                                }
                            }

                        }
                    }
                    if (i == 4) {
                        cData[i] = newarr;
                    }
                    cData[4].sort(function (a, b) {
                        return new Date(a.xdata + '-01') - new Date(b.xdata + '-01');
                    });
                }
                if (i == 6 || i == 18) {
                    var newarr = [], tavl = 0, tval1 = "";
                    if (cData[i - 1].length >= cData[i].length) {
                        sarr = cData[i - 1];
                        farr = cData[i];
                        nflag = true;
                    } else {
                        sarr = cData[i];
                        farr = cData[i - 1];
                        nflag = false;
                    }
                    for (var k = 0; k < sarr.length; k++) {
                        findex = newarr.findIndex(item => item.xdata === sarr[k]["xdata"]);
                        if (findex == -1) {
                            item1 = farr.find(item => item.xdata === sarr[k]["xdata"]);
                            if (nflag) {
                                if (item1 == undefined) {
                                    val1 = sarr[k]["ydata"];
                                    val2 = 0;
                                } else {
                                    val1 = sarr[k]["ydata"];
                                    val2 = item1["ydata"];
                                }
                            } else {
                                if (item1 == undefined) {
                                    val1 = 0;
                                    val2 = sarr[k]["ydata"];
                                } else {
                                    val1 = item1["ydata"];
                                    val2 = sarr[k]["ydata"];
                                }
                            }
                            if (val2 == 0) {
                                tval = 0;
                            } else {
                                tval = parseFloat(val1 / val2).toFixed(2);
                            }
                            if (i == 6) {
                                newarr[k] = { 'xdata': sarr[k]["xdata"], 'ydata': tval, 'add': val1, 'remove': val2, 'ydata1': 0, 'add1': 0, 'remove1': 0 };
                            } else {
                                findex = cData[6].findIndex(item => item.xdata === sarr[k]["xdata"]);
                                if (findex == -1) {
                                    cData[6].push({ "xdata": sarr[k]["xdata"], 'ydata': 0, 'ydata1': tval, 'remove1': val2, 'add1': val1, 'remove': 0, 'add': 0 });
                                } else {
                                    cData[6][findex]["ydata1"] = tval;
                                    cData[6][findex]["add1"] = val1;
                                    cData[6][findex]["remove1"] = val2;
                                }
                            }
                        }
                    }
                    if (i == 6) {
                        cData[i] = newarr;
                    }
                    cData[6].sort(function (a, b) {
                        return new Date(a.xdata + '-01') - new Date(b.xdata + '-01');
                    });
                }
                if (i == 8 || i == 20) {
                    var newarr = [], tavl = 0, tval1 = "";
                    if (cData[i - 1]["avg"].length >= cData[i].length) {
                        sarr = cData[i - 1]["avg"];
                        farr = cData[i];
                        nflag = true;
                    } else {
                        sarr = cData[i];
                        farr = cData[i - 1]["avg"];
                        nflag = false;
                    }
                    for (var k = 0; k < sarr.length; k++) {
                        findex = newarr.findIndex(item => item.xdata === sarr[k]["xdata"]);
                        if (findex == -1) {
                            item1 = farr.find(item => item.xdata === sarr[k]["xdata"]);
                            if (nflag) {
                                if (item1 == undefined) {
                                    val1 = sarr[k]["ydata"];
                                    val2 = 0;
                                } else {
                                    val1 = sarr[k]["ydata"];
                                    val2 = item1["ydata"];
                                }
                            } else {
                                if (item1 == undefined) {
                                    val1 = 0;
                                    val2 = sarr[k]["ydata"];
                                } else {
                                    val1 = item1["ydata"];
                                    val2 = sarr[k]["ydata"];
                                }
                            }
                            if (val2 == 0) {
                                tval = 0;
                            } else {
                                tval = parseFloat(val1 / val2 * 1000).toFixed(2);
                            }

                            if (i == 8) {
                                newarr[k] = { 'xdata': sarr[k]["xdata"], 'ydata': tval, 'avg': val1, 'num': val2, 'ydata1': 0, 'avg1': 0, 'num1': 0 };
                            } else {
                                findex = cData[8].findIndex(item => item.xdata === sarr[k]["xdata"]);
                                if (findex == -1) {
                                    cData[8].push({ "xdata": sarr[k]["xdata"], 'ydata': 0, 'ydata1': tval, 'num1': val2, 'avg1': val1, 'num': 0, 'avg': 0 });
                                } else {
                                    cData[8][findex]["ydata1"] = tval;
                                    cData[8][findex]["avg1"] = val1;
                                    cData[8][findex]["num1"] = val2;
                                }
                            }
                        }
                    }
                    if (i == 8) {
                        cData[i] = newarr;
                    }
                    cData[8].sort(function (a, b) {
                        return new Date(a.xdata + '-01') - new Date(b.xdata + '-01');
                    });
                }
                if (i == 11 || i == 23) {
                    var newarr = [], tavl = 0, tval1 = "";
                    if (cData[i - 1].length >= cData[i].length) {
                        sarr = cData[i - 1];
                        farr = cData[i];
                        nflag = true;
                    } else {
                        sarr = cData[i];
                        farr = cData[i - 1];
                        nflag = false;
                    }
                    for (var k = 0; k < sarr.length; k++) {
                        findex = newarr.findIndex(item => item.xdata === sarr[k]["xdata"]);
                        if (findex == -1) {
                            item1 = farr.find(item => item.xdata === sarr[k]["xdata"]);
                            if (nflag) {
                                if (item1 == undefined) {
                                    val1 = sarr[k]["ydata"];
                                    val2 = 0;
                                } else {
                                    val1 = sarr[k]["ydata"];
                                    val2 = item1["ydata"];
                                }
                            } else {
                                if (item1 == undefined) {
                                    val1 = 0;
                                    val2 = sarr[k]["ydata"];
                                } else {
                                    val1 = item1["ydata"];
                                    val2 = sarr[k]["ydata"];
                                }
                            }
                            if (val2 == 0) {
                                tval = 0;
                            } else {
                                tval = parseFloat(val1 / val2).toFixed(2);
                            }

                            if (i == 11) {
                                newarr[k] = { 'xdata': sarr[k]["xdata"], 'ydata': tval, 'num': val2, 'acc': val1, 'ydata1': 0, 'num1': 0, 'acc1': 0 };
                            } else {
                                findex = cData[11].findIndex(item => item.xdata === sarr[k]["xdata"]);
                                if (findex == -1) {
                                    cData[11].push({ "xdata": sarr[k]["xdata"], 'ydata': 0, 'ydata1': tval, 'num1': val2, 'acc1': val1, 'num': 0, 'acc': 0 });
                                } else {
                                    cData[11][findex]["ydata1"] = tval;
                                    cData[11][findex]["acc1"] = val1;
                                    cData[11][findex]["num1"] = val2;
                                }
                            }
                        }
                    }
                    if (i == 11) {
                        cData[i] = newarr;
                    }
                    cData[11].sort(function (a, b) {
                        return new Date(a.xdata + '-01') - new Date(b.xdata + '-01');
                    });
                }
            } else {
                var newarr = [], deges = [], nname = "", ename = "", thisval = 0, garr = [];
                for (var k = 0; k < cData[i]["nodes"].length; k++) {
                    newarr[k] = { 'name': cData[i]["nodes"][k][0], 'value': cData[i]["nodes"][k][1], 'linkWith': [], 'children': [] };
                }
                for (var m = 0; m < cData[i]["edges"].length; m++) {
                    ename = cData[i]["edges"][m][0];
                    nname = cData[i]["edges"][m][1];
                    thisval = cData[i]["edges"][m][2];
                    let index = newarr.findIndex(item => item.name === nname);
                    if (garr.includes(ename)) {
                        newarr[index]["linkWith"].push(ename);
                    } else {
                        newarr[index]["children"].push({ "name": ename, "value": thisval });
                        garr.push(ename);
                    }
                }
                cData[i] = newarr;
            }
        }
        if (warehouse_name != "" && warehouse_name1 != "") {
            isboth = true;
            $("#chartdiv9").css("display", "block");
            $("#chartdiv4").height($("#chartdiv4").width());
            $("#chartdiv9").height($("#chartdiv9").width());
            $("#titlebox").css("height", "30px");
            $("#titlebox").html('<div id="t1" style="flex:1;text-align:center;line-height: 40px; color:#fff;">仓库1</div><div id="t2" style="flex:1;text-align:center;line-height: 40px; color:#fff;">仓库2</div>');
            $("#titlebox").css("display", "flex");
        } else {
            $("#chartdiv9").css("display", "none");
            $("#titlebox").css("height", "1px");
            $("#titlebox").html('');
            $("#titlebox").css("display", "none");
        }

        console.log(cData)
        var chart;
        for (var i = 0; i < dataarr.length; i++) {
            showchart(dataarr[i]);
        }

    }


    function xmldata(urlstr) {
        var vdata;
        $.ajax({
            type: 'get',
            url: urlstr, /*确认变更*/
            async: false,        //需要async属性调整为false，默认是true;
            success: function (data, textStatus) {
                vdata = data;
            },
            error: function (xhr, status, error) {
                vdata = "failed";
                if (xhr.status === 404) {
                    // console.log("URL 错误或资源不存在");
                }
            }
        });
        return vdata;
    }


    geturldata();

    function showchart(minfo) {
        chartData = cData[minfo.index];
        if (minfo.index != 2 && minfo.index != 14) {
            am4core.ready(function () {
                // Themes begin
                am4core.useTheme(am4themes_animated);
                // Themes end
                // Create chart instance
                var chart = am4core.create(minfo.divname, am4charts.XYChart);
                var title = chart.titles.create();
                title.text = minfo.title;
                title.fill = "#ffffff";
                title.fontSize = 16;
                title.paddingBottom = 5;

                // Export
                // chart.exporting.menu = new am4core.ExportMenu();
                chart.color = "#ffffff";
                // Data for both series
                /* Create axes */
                var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
                categoryAxis.dataFields.category = "xdata";
                categoryAxis.renderer.line.strokeOpacity = 0.8;
                categoryAxis.renderer.line.stroke = "#fff";
                // categoryAxis.gridAlpha=0;
                categoryAxis.renderer.labels.template.fillOpacity = 0.8;
                categoryAxis.renderer.labels.template.fill = "#ffffff";
                categoryAxis.renderer.labels.template.fontSize = "12px";
                categoryAxis.renderer.grid.template.disabled = true;
                categoryAxis.renderer.labels.template.rotation = 0;
                // categoryAxis.renderer.labels.template.hideOversized = false;
                categoryAxis.renderer.minGridDistance = 60;

                var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
                valueAxis.renderer.line.strokeOpacity = 0.8;
                valueAxis.renderer.line.stroke = "#fff";
                // valueAxis.gridAlpha=0;
                // valueAxis.renderer.ticks.template.length = 10;
                valueAxis.renderer.labels.template.fillOpacity = 0.8;
                valueAxis.renderer.labels.template.fill = "#ffffff";
                valueAxis.renderer.labels.template.fontSize = "12px";
                // valueAxis.renderer.grid.template.strokeOpacity = 0;
                // valueAxis.renderer.ticks.template.strokeOpacity = 0.4;
                valueAxis.renderer.grid.template.disabled = true;
                // valueAxis.renderer.minGridDistance = 10;
                if (minfo.preflag) {
                    valueAxis.renderer.labels.template.adapter.add("text", function (text) {
                        return text + "%";
                    })
                }
                // valueAxis.title.text = "Y轴标题";
                var lineSeries = chart.series.push(new am4charts.LineSeries());
                lineSeries.dataFields.valueY = "ydata";
                lineSeries.dataFields.categoryX = "xdata";

                lineSeries.stroke = am4core.color("#dc67ce");
                lineSeries.tooltip.label.textAlign = "left";
                lineSeries.strokeWidth = 2;
                lineSeries.fill = "#dc67ce";
                lineSeries.fillOpacity = 0.1;

                var bullet = lineSeries.bullets.push(new am4charts.Bullet());
                bullet.fill = am4core.color("#dc67ce");

                bullet.tooltipText = minfo.tipformat;//"{categoryX}: [b]{valueY}[/b]";
                var circle = bullet.createChild(am4core.Circle);
                circle.radius = 5;
                circle.fill = am4core.color("#dc67ce");
                circle.stroke = "#fff";
                circle.strokeWidth = 1;

                if (isboth) {
                    var lineSeries = chart.series.push(new am4charts.LineSeries());
                    lineSeries.dataFields.valueY = "ydata1";
                    lineSeries.dataFields.categoryX = "xdata";

                    lineSeries.stroke = am4core.color("#dcd267");
                    lineSeries.tooltip.label.textAlign = "left";
                    lineSeries.strokeWidth = 2;
                    lineSeries.fill = "#dcd267";
                    lineSeries.fillOpacity = 0.1;

                    var bullet = lineSeries.bullets.push(new am4charts.Bullet());
                    bullet.fill = am4core.color("#dcd267");
                    // bullet.tooltipText = "[#000 font-size: 15px]{name} in {categoryX}:\n[/][#fff font-size: 20px]{valueY}[/] [#fff]{additional}[/]"
                    bullet.tooltipText = minfo.tipformat1;//"{categoryX}: [b]{valueY}[/b]";
                    var circle = bullet.createChild(am4core.Circle);
                    circle.radius = 5;
                    circle.fill = am4core.color("#dcd267");
                    circle.stroke = "#fff";
                    circle.strokeWidth = 1;
                }

                chart.data = cData[minfo.index];

                // chart.legend = new am4charts.Legend();
                chart.cursor = new am4charts.XYCursor();
                // var label = chart.plotContainer.createChild(am4core.Label);
                // label.text = "Pan chart to change date";
                // label.fill="#ffffff";
                // label.x = 0;
                // label.y = -45;

                chart.scrollbarX = new am4core.Scrollbar();
                chart.scrollbarX.background.fill = "#447bc5";
                chart.scrollbarX.background.fillOpacity = 0.5;
                chart.scrollbarX.background.stroke = am4core.color("#447bc5");
                chart.scrollbarX.background.strokeWidth = 0;

                // 可选：设置滑块颜色
                chart.scrollbarX.thumb.background.fill = am4core.color('#444ecb');
                chart.scrollbarX.thumb.background.fillOpacity = 0.8;
                chart.scrollbarX.thumb.strokeWidth = 0;
                chart.scrollbarX.parent = chart.bottomAxesContainer;
            });
        } else {
            am4core.ready(function () {
                // Themes begin
                am4core.useTheme(am4themes_animated);
                // Themes end
                var chart = am4core.create(minfo.divname, am4plugins_forceDirected.ForceDirectedTree);
                var networkSeries = chart.series.push(new am4plugins_forceDirected.ForceDirectedSeries())
                networkSeries.dataFields.linkWith = "linkWith";
                networkSeries.dataFields.name = "name";
                networkSeries.dataFields.id = "name";
                networkSeries.dataFields.value = "value";
                networkSeries.dataFields.children = "children";

                networkSeries.nodes.template.label.text = "{name}"
                networkSeries.fontSize = 12;
                networkSeries.linkWithStrength = 0;

                var nodeTemplate = networkSeries.nodes.template;
                nodeTemplate.tooltipText = "{name}";
                nodeTemplate.fillOpacity = 1;
                nodeTemplate.label.hideOversized = true;
                nodeTemplate.label.truncate = true;

                var linkTemplate = networkSeries.links.template;
                linkTemplate.strokeWidth = 1;
                var linkHoverState = linkTemplate.states.create("hover");
                linkHoverState.properties.strokeOpacity = 1;
                linkHoverState.properties.strokeWidth = 2;

                nodeTemplate.events.on("over", function (event) {
                    var dataItem = event.target.dataItem;
                    dataItem.childLinks.each(function (link) {
                        link.isHover = true;
                    })
                })

                nodeTemplate.events.on("out", function (event) {
                    var dataItem = event.target.dataItem;
                    dataItem.childLinks.each(function (link) {
                        link.isHover = false;
                    })
                })

                networkSeries.data = cData[minfo.index];

            });
        }
    }

</script>

</html>